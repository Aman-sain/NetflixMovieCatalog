name: Netflix Backend Service Deployment

on:
  push:
    branches:
      - main

env:
  EC2_PUBLIC_IP_1: 3.68.135.25  # Instance 1 Public IP
  EC2_PUBLIC_IP_2: 3.76.147.224  # Instance 2 Public IP
  EC2_PUBLIC_IP_3: 18.153.39.26   # Instance 3 Public IP
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}  # Define the SSH private key in GitHub Secrets
  DOCKER_USERNAME: amansain01  # Your Docker Hub username
  DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}  # Define the Docker access token in GitHub Secrets

jobs:
  Deploy-Backend:
    name: Deploy Backend to EC2 Instances
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the backend code
        uses: actions/checkout@v2

      # Step 1: Set up Docker
      - name: Set up Docker
        run: |
          echo "Updating package list..."
          sudo yum update -y
          echo "Installing necessary dependencies..."
          sudo yum install -y amazon-linux-extras
          sudo amazon-linux-extras install docker -y
          sudo systemctl start docker
          sudo systemctl enable docker

      # Step 2: Run Backend Tests
      - name: Run Backend Tests
        run: |
          cd /home/runner/work/NetflixMovieCatalog/NetflixMovieCatalog/
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          pytest tests/test.py

      # Step 3: Build Docker image for the backend service
      - name: Build Docker image
        run: |
          cd /home/runner/work/NetflixMovieCatalog/NetflixMovieCatalog/
          docker build -t netflix-backend:latest .

      # Step 4: Tag and Push Docker image
      - name: Tag and Push Docker image
        run: |
          docker tag netflix-backend:latest amansain01/netflix-movie-catalog:v0.0.1
          echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u $DOCKER_USERNAME --password-stdin
          docker push amansain01/netflix-movie-catalog:v0.0.1

      # Step 5: SSH to the Backend EC2 instances and deploy the backend
      - name: Deploy to EC2 Instance 1
        run: |
          set -x
          echo "$SSH_PRIVATE_KEY" > aws_key.pem
          chmod 600 aws_key.pem
          ssh -o StrictHostKeyChecking=accept-new -i aws_key.pem ec2-user@$EC2_PUBLIC_IP_1 "sudo yum update -y && sudo yum install -y docker && sudo systemctl start docker && sudo docker pull amansain01/netflix-movie-catalog:v0.0.1 && bash deploy.sh"

      - name: Deploy to EC2 Instance 2
        run: |
          ssh -o StrictHostKeyChecking=accept-new -i aws_key.pem ec2-user@$EC2_PUBLIC_IP_2 "sudo yum update -y && sudo yum install -y docker && sudo systemctl start docker && sudo docker pull amansain01/netflix-movie-catalog:v0.0.1 && bash deploy.sh"

      - name: Deploy to EC2 Instance 3
        run: |
          ssh -o StrictHostKeyChecking=accept-new -i aws_key.pem ec2-user@$EC2_PUBLIC_IP_3 "sudo yum update -y && sudo yum install -y docker && sudo systemctl start docker && sudo docker pull amansain01/netflix-movie-catalog:v0.0.1 && bash deploy.sh"
